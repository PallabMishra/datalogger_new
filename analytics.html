<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voltage Data Aggregation and Monitoring System - Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datamaps/0.5.9/datamaps.ind.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f2fb;
        }

        .dropdown-checkboxes {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 10;
            background: #fff;
            color: #003366;
            border: 1px solid #ccc;
            padding: 10px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            width: 200px;
        }

        .dropdown-checkboxes.show {
            color: #28a745;
            display: block;
        }

        .dropdown-checkboxes input[type="text"] {
            background: #fff;
            width: 100%;
            margin-bottom: 8px;
            padding: 4px;
        }

        .pincode-search-container {
            width: 130px;
        }

        .pincode-search-container .search-box {
            display: flex;
            align-items: center;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .pincode-search-container input {
            border: none;
            padding: 6px;
            outline: none;
        }

        .search-box {
            position: relative;
            margin-bottom: 5px;
        }

        .search-box input {
            width: 100%;
            padding: 6px 30px 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .search-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #aaa;
        }

        button {
            background-color: #0055cc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #003d99;
        }

        .report-popup-button {
            background-color: #28a745;
            position: absolute;
            right: 20px;
            top: 80px;
        }

        .filter-button {
            background-color: #ffa500;
        }

        .filter-button-new {
            background-color: #40ff00;
        }



        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .user-circle {
            background-color: #ddd;
            color: #0b3b91;
            border-radius: 50%;
            padding: 5px 10px;
            width: 34px;
            height: 34px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
        }

        #selectedStates {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-container {
            display: flex;
            gap: 24px;
            padding: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .card {
            flex: 1 1 180px;
            max-width: 240px;
            border-radius: 12px;
            padding: 24px 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 110px;
        }

        .total-devices {
            background-color: #c2d9f9;
            color: #064a9e;
            border: 1.5px solid #a1c3f9;
        }

        .devices-online {
            background-color: #c9e4c5;
            color: #3a6f34;
            border: 1.5px solid #a3d3a5;
        }

        .devices-uptime {
            background-color: #bbb0fa;
            /* Light green */
            color: #110981;
            /* Dark green text (fully visible) */
            border: 1.5px solid #f7a2a2;
            /* Light red border */
            padding: 10px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            text-align: center;
        }


        .analytics {
            background-color: #d7c7f9;
            color: #532e99;
            border: 1.5px solid #bfa0f9;
            cursor: pointer;
            user-select: none;
        }

        .analytics:hover {
            background-color: #c4b1f5;
        }

        .card h3,
        .card p {
            text-align: center;
            margin: 0;
        }

        .main-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            justify-content: center;
        }

        .tab-container {
            display: flex;
            align-items: center;
            gap: 25px;
            padding: 16px 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            justify-content: center;
        }

        .tab {
            background-color: #f0f0f5;
            border: 2px solid transparent;
            padding: 12px 28px;
            font-weight: 700;
            font-size: 17px;
            border-radius: 30px;
            cursor: pointer;
            user-select: none;
            color: #555555;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgb(0 0 0 / 0.08);
            min-width: 110px;
            text-align: center;
        }

        .tab:hover {
            background-color: #e6e6ff;
            color: #4f46e5;
            /* Indigo-600 */
        }

        .tab.active {
            background-color: #4f46e5;
            /* Indigo-600 */
            color: #fff;
            border-color: #4338ca;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        /* Dropdowns */
        .tab-container select {
            padding: 10px 16px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            border: 2px solid #ddd;
            background-color: #fafafa;
            cursor: pointer;
            min-width: 160px;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            box-shadow: inset 0 1px 3px rgb(0 0 0 / 0.1);
            color: #333;
        }

        .tab-container select:hover,
        .tab-container select:focus {
            border-color: #4f46e5;
            background-color: #fff;
            outline: none;
            box-shadow: 0 0 8px rgba(79, 70, 229, 0.5);
        }


        #chartContainer {
            width: 90%;
            height: 500px;
            margin: auto;
        }

        .report-popup {
            display: none;
            position: absolute;
            top: 120px;
            right: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 16px;
            width: 200px;
            z-index: 10;
        }

        .report-popup-content {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            width: 320px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .report-popup-content select {
            padding: 6px;
            margin-top: 5px;
            border-radius: 4px;
        }

        .report-popup label {
            display: block;
            margin-bottom: 5px;
        }

        .pincode-item {
            padding: 6px 10px;
            border-bottom: 1px solid #eee;
            cursor: default;
        }

        .chart-container {
            display: flex;
            justify-content: center;
            /* center horizontally */
            align-items: center;
            /* center vertically */
            height: 400px;
            /* same as max-height or desired height */
            width: 100%;
        }


        #weekSelector {
            font-size: 18px;
            font-weight: bold;
            margin: 20px;
        }

        #weekSelector button {
            padding: 6px 12px;
            font-size: 18px;
            cursor: pointer;
        }

        .select2-container {
            width: 150px !important;
        }



        .dropdown-button {
            padding: 10px 14px;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            min-width: 200px;
        }

        .dropdown-menu {
            position: absolute;
            top: 105%;
            left: 0;
            z-index: 10;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu label {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
        }

        .dropdown-menu input[type="checkbox"] {
            margin-right: 8px;
        }

        .dropdown-container {
            position: relative;
            width: 250px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        .custom-multiselect {
            width: 100%;
            padding: 10px 15px;
            font-size: 16px;
            text-align: center;
            background-color: #f3ebeb;
            border: 1.8px solid #007bff;
            color: #0056b3;

            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgb(0 123 255 / 0.2);
        }

        .custom-multiselect:hover {
            background-color: #b1c7f6;
        }

        .dropdown-checkboxes {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background-color: #ffffff;
            border: 1.8px solid #007bff;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 6px 15px rgb(0 123 255 / 0.25);
            z-index: 1000;
            display: none;
            padding: 10px 12px;
        }

        .dropdown-checkboxes.show {
            color: #28a745;
            display: block;
        }

        .dropdown-checkboxes input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 10px;
            font-size: 14px;
            border: 1.4px solid #007bff;
            border-radius: 4px;
            outline: none;
        }

        .dropdown-checkboxes label {
            display: flex;
            align-items: center;
            padding: 5px 8px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .dropdown-checkboxes input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .dropdown-checkboxes label:hover {
            background-color: #e9f0ff;
        }


        .dropdown-checkboxes input[type="text"]:focus {
            border-color: #0056b3;
            box-shadow: 0 0 5px #0056b3;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            padding: 8px 0;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            /* Left and right */
            padding: 8px 0;
            align-items: center;
        }

        .icon-button {
            font-size: 16px;
            /* smaller overall size */
            color: #007bff;
            cursor: pointer;
            user-select: none;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            /* small space between icon and text */
        }


        .action-buttons button:hover {
            background-color: #9ac4f1;
        }


        .pincode-search-container {
            width: 160px;

            font-family: Arial, sans-serif;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f9f9f9;
            border: 1.5px solid #007bff;
            border-radius: 8px;
            padding: 6px 10px;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.15);
            transition: box-shadow 0.3s ease;
        }

        .search-box:focus-within {
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
            color: #333;
        }

        .search-icon {
            font-size: 16px;
            color: #007bff;
            margin-left: 5px;
            cursor: pointer;
        }

        .search-icon:hover {
            color: #0056b3;
        }

        button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background-color: #0077cc;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background: #f0f4ff;
        }

        .report-popup-button {
            background-color: #28a745;
            position: absolute;
            right: 20px;
            top: 80px;
        }

        .filter-button {
            background-color: #ffa500;
        }

        .filter-button-new {
            background-color: #40ff00;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .user-circle {
            background-color: #555;
            color: white;
            border-radius: 50%;
            padding: 5px 10px;
            width: 34px;
            height: 34px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
        }

        #selectedStates {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-container {
            display: flex;
            gap: 24px;
            padding: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .card {
            flex: 1 1 180px;
            max-width: 240px;
            border-radius: 12px;
            padding: 24px 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 110px;
        }

        .total-devices {
            background-color: #c2d9f9;
            color: #064a9e;
            border: 1.5px solid #a1c3f9;
        }

        .devices-online {
            background-color: #c9e4c5;
            color: #3a6f34;
            border: 1.5px solid #a3d3a5;
        }

        .devices-offline {
            background-color: #f9c2c2;
            color: #a53232;
            border: 1.5px solid #f7a2a2;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            transform: scale(1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .devices-offline:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .click-me {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            font-size: 14px;
            font-weight: bold;
            color: #a53232;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s ease;
        }

        .devices-offline:hover .click-me {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }


        .analytics {
            background-color: #d7c7f9;
            color: #532e99;
            border: 1.5px solid #bfa0f9;
            cursor: pointer;
            user-select: none;
        }

        .analytics:hover {
            background-color: #c4b1f5;
        }

        .card h3,
        .card p {
            text-align: center;
            margin: 0;
        }

        .main-container {
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        #indiaMap {
            flex: 2;
            height: 500px;
        }

        .report-popup {
            display: none;
            position: absolute;
            top: 120px;
            right: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 16px;
            width: 200px;
            z-index: 10;
        }

        .report-popup-content select {
            padding: 6px;
            margin-top: 5px;
            border-radius: 4px;
        }


        .report-popup label {
            display: block;
            margin-bottom: 5px;
        }

        .pincode-item {
            padding: 6px 10px;
            border-bottom: 1px solid #eee;
            cursor: default;
        }

        #reportPopup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .report-popup-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            min-width: 300px;
            position: relative;
        }

        .popup-close-icon {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 20px;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #003366;
            /* example background */
            padding: 10px 20px;
            color: white;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
        }

        .branding {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .home-icon {
            text-decoration: none;
            font-size: 24px;
            display: flex;
            align-items: center;
        }

        .brand-text {
            color: white;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
        }

        .filter {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="navbar-left">
            <div class="branding">
                <a href="index.html" class="home-icon" title="Home">🏠</a>
                <span class="brand-text">Voltage Analytics</span>
            </div>
        </div>

        <div class="navbar-right">
            <div class="dropdown-container">
                <button class="custom-multiselect" onclick="toggleDropdown()">Select States or UTs</button>
                <div class="dropdown-checkboxes" id="stateList">
                    <input type="text" placeholder="Search states..." onkeyup="filterStates(this.value)" />
                    <div class="action-buttons">
                        <span class="icon-button" title="Select All" onclick="selectAllStates()">✅ <small>Select
                                All</small></span>
                        <span class="icon-button" title="Clear All" onclick="clearAllStates()">❌ <small>Clear
                                All</small></span>
                    </div>
                    <div id="statesCheckboxContainer"></div>
                </div>
            </div>

            <div class="dropdown-container">
                <button class="custom-multiselect" onclick="toggleDistrictDropdown()">Select Districts</button>
                <div class="dropdown-checkboxes" id="districtList">
                    <input type="text" placeholder="Search..." onkeyup="filterDistricts(this.value)" />
                    <div class="action-buttons">
                        <span class="icon-button" title="Select All" onclick="selectAllDistricts()">✅ <small>Select
                                All</small></span>
                        <span class="icon-button" title="Clear All" onclick="clearAllDistricts()">❌ <small>Clear
                                All</small></span>
                    </div>
                    <div id="districtCheckboxContainer"></div>
                </div>
            </div>

            <div class="dropdown-container">
                <button class="custom-multiselect" onclick="toggleBranchDropdown()">Select Branch</button>
                <div class="dropdown-checkboxes" id="branchList">
                    <input type="text" placeholder="Search branch..." onkeyup="filterBranches(this.value)" />
                    <div class="action-buttons">
                        <span class="icon-button" title="Select All" onclick="selectAllBranches()">✅ <small>Select
                                All</small></span>
                        <span class="icon-button" title="Clear All" onclick="clearAllBranches()">❌ <small>Clear
                                All</small></span>
                    </div>
                    <div id="branchCheckboxContainer"></div>
                </div>
            </div>

            <div class="pincode-search-container">
                <div class="search-box">
                    <input type="text" id="pincodeSearch" placeholder="Search Pincode" onkeyup="searchPincode()" />
                    <span class="search-icon" onclick="searchPincode()">🔍</span>
                </div>
            </div>
            <button class="filter-button">Filter</button>
            <button class="filter-button-new" onclick="toggleReportPopup()">Generate Report</button>
            <div class="user-info">
                Pallab
                <div class="user-circle">US</div>
            </div>
        </div>
    </nav>



    <div id="reportPopup" style="display: none; position: fixed; top: 0; left: 0; 
    width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">

        <div class="report-popup-content"
            style="position: relative; background: #fff; padding: 20px; border-radius: 10px; min-width: 300px;">
            <span class="popup-close-icon" onclick="toggleReportPopup()">×</span>
            <h3>Generate Report</h3>
            <p id="selectionInfo">You selected: State - N/A, District - N/A, Pincode - N/A</p>
           
            <div id="dynamicOptions" style="margin-top: 10px;"></div>
            <div style="margin-top: 15px;">
                <button onclick="downloadReport()">Download</button>
            </div>
        </div>
    </div>



    <div class="stats-container">
        <div class="card total-devices">
            <h3>Total Devices</h3>
            <p>123,456</p>
        </div>
        <div class="card devices-online">
            <h3>Devices Online</h3>
            <p>5,678</p>
        </div>
        <div class="card devices-offline">
            <h3>Devices Offline</h3>
            <p>1,234</p>
            <span class="click-me">Click Here</span>
        </div>
        <div class="card devices-uptime">
            <h3> Cumulative Uptime</h3>
            <p>28 Hrs.</p>
        </div>

    </div>
    <div class="tab-container" style="display: flex; align-items: center; gap: 10px;">
        <div id="weekSelector" style="display: flex; align-items: center; gap: 10px;">
            <button onclick="changeWeek(-1)">&#8592;</button>
            <button class="tab active" data-period="week">Weekly</button>
            <button onclick="changeWeek(1)">&#8594;</button>
        </div>

        <div id="monthSelector" style="display: flex; align-items: center; gap: 10px;">
            <button onclick="changeMonth(-1)">&#8592;</button>
            <button class="tab" data-period="month">Monthly</button>
            <button onclick="changeMonth(1)">&#8594;</button>
        </div>

        <button class="tab" data-period="yearly">Yearly</button>


        <select id="yearSelect">
            <option value="all" selected>Select Year</option>
            <option value="2023">☐ 2023</option>
            <option value="2024">☐ 2024</option>
            <option value="2025">☐ 2025</option>
        </select>

        <select id="voltageBandSelect" style="font-family: monospace;">
            <option value="all" selected>All Voltage Bands</option>
            <option value="<150">☐ &lt;130</option>
            <option value="130-150">☐ 130-150</option>
            <option value="150-180">☐ 150-180</option>
            <option value="180-210">☐ 180-210</option>
            <option value="210-250">☐ 210-250</option>
            <option value=">250">☐ &gt;250</option>
        </select>


    </div>

    <div id="periodDisplay" style="font-weight: bold; margin-top: 10px; text-align: center;"></div>


    <div class="chart-container">
        <canvas id="periodChart"></canvas>
    </div>

    <script>

        function toggleBranchDropdown() {
            document.getElementById("branchList").classList.toggle("show");
        }

        function filterBranches(searchText) {
            const container = document.getElementById("branchCheckboxContainer");
            const checkboxes = container.querySelectorAll("label");
            checkboxes.forEach(label => {
                const text = label.textContent.toLowerCase();
                label.style.display = text.includes(searchText.toLowerCase()) ? "block" : "none";
            });
        }

        function selectAllBranches() {
            const checkboxes = document.querySelectorAll("#branchCheckboxContainer input[type='checkbox']");
            checkboxes.forEach(cb => cb.checked = true);
        }

        function clearAllBranches() {
            const checkboxes = document.querySelectorAll("#branchCheckboxContainer input[type='checkbox']");
            checkboxes.forEach(cb => cb.checked = false);
        }

        // Add dummy branches on page load
        document.addEventListener("DOMContentLoaded", () => {
            const branches = [
                "Central Branch",
                "North Zone Branch",
                "South Division",
                "East Power Unit",
                "West Operations",
                "Metro City Branch",
                "Rural Service Center"
            ];
            const container = document.getElementById("branchCheckboxContainer");
            container.innerHTML = "";
            branches.forEach(branch => {
                const label = document.createElement("label");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = branch;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(branch));
                container.appendChild(label);
            });
        });
        function downloadReport() {
            // Dummy user data
            const data = [
                { Name: "Alice Johnson", Email: "alice@example.com", LoginTime: "2025-05-27 08:00 AM" },
                { Name: "Bob Smith", Email: "bob@example.com", LoginTime: "2025-05-27 09:15 AM" },
                { Name: "Charlie Lee", Email: "charlie@example.com", LoginTime: "2025-05-27 10:00 AM" }
            ];

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Login Report");

            XLSX.writeFile(workbook, "User_Login_Report.xlsx");
        }
        function toggleReportPopup() {
            const popup = document.getElementById('reportPopup');
            const isVisible = popup.style.display === 'flex';

            popup.style.display = isVisible ? 'none' : 'flex';

            if (!isVisible) {
                const selectedState = document.querySelector('.custom-multiselect')?.innerText || 'N/A';
                const selectedDistrict = document.querySelectorAll('.custom-multiselect')[1]?.innerText || 'N/A';
                const selectedPincode = document.getElementById('pincodeSearch')?.value || 'N/A';

                document.getElementById('selectionInfo').innerText =
                    `You selected: State - ${selectedState}, District - ${selectedDistrict}, Pincode - ${selectedPincode}`;
            }
        }
        const dummyKeralaDistricts = [
            "Thiruvananthapuram", "Kollam", "Pathanamthitta", "Alappuzha", "Kottayam",
            "Idukki", "Ernakulam", "Thrissur", "Palakkad", "Malappuram",
            "Kozhikode", "Wayanad", "Kannur", "Kasaragod",
            "Perumbavoor", "Nedumangad", "Kattakada", "Karunagappally", "Chengannur",
            "Pala", "Muvattupuzha", "Chalakudy", "Ottapalam", "Manjeri",
            "Vatakara", "Kalpetta", "Thalassery", "Payyanur", "Kanhangad"
        ];
        function toggleDistrictDropdown() {
            const dropdown = document.getElementById("districtList");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }
        function loadDummyDistricts() {
            const container = document.getElementById("districtCheckboxContainer");
            container.innerHTML = "";
            dummyKeralaDistricts.forEach(district => {
                const label = document.createElement("label");
                label.innerHTML = `<input type="checkbox" value="${district}"> ${district}`;
                container.appendChild(label);
            });
        }
        function selectAllDistricts() {
            document.querySelectorAll('#districtCheckboxContainer input[type="checkbox"]')
                .forEach(cb => cb.checked = true);
        }
        function clearAllDistricts() {
            document.querySelectorAll('#districtCheckboxContainer input[type="checkbox"]')
                .forEach(cb => cb.checked = false);
        }
        function filterDistricts(value) {
            const search = value.toLowerCase();
            document.querySelectorAll("#districtCheckboxContainer label").forEach(label => {
                label.style.display = label.textContent.toLowerCase().includes(search) ? "block" : "none";
            });
        }
        window.onload = loadDummyDistricts;
        document.addEventListener("DOMContentLoaded", fetchStates);
        function fetchStates() {
            const states = [
                "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh",
                "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand",
                "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur",
                "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab",
                "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura",
                "Uttar Pradesh", "Uttarakhand", "West Bengal",
                "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu",
                "Delhi", "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry"
            ].sort();

            const container = document.getElementById("statesCheckboxContainer");
            container.innerHTML = "";
            states.forEach(state => {
                const label = document.createElement("label");
                label.innerHTML = `<input type="checkbox" value="${state}"> ${state}`;
                container.appendChild(label);
            });
        }
        function toggleDropdown() {
            const list = document.getElementById('stateList');
            list.style.display = list.style.display === 'block' ? 'none' : 'block';
        }
        function filterStates(searchValue) {
            const input = searchValue.toLowerCase();
            const labels = document.querySelectorAll("#statesCheckboxContainer label");
            labels.forEach(label => {
                label.style.display = label.textContent.toLowerCase().includes(input) ? "block" : "none";
            });
        }
        function selectAllStates() {
            const checkboxes = document.querySelectorAll("#statesCheckboxContainer input[type='checkbox']");
            checkboxes.forEach(cb => cb.checked = true);
        }
        function clearAllStates() {
            const checkboxes = document.querySelectorAll("#statesCheckboxContainer input[type='checkbox']");
            checkboxes.forEach(cb => cb.checked = false);
        }
        function filterDistricts(searchValue) {
            const input = searchValue.toLowerCase();
            const labels = document.querySelectorAll("#districtsCheckboxContainer label");
            labels.forEach(label => {
                label.style.display = label.textContent.toLowerCase().includes(input) ? "block" : "none";
            });
        }

        function addStateListeners() {
            const checkboxes = document.querySelectorAll("#statesCheckboxContainer input[type='checkbox']");
            checkboxes.forEach(cb => cb.addEventListener("change", updateDistrictList));
        }
        async function updateDistrictList() {
            const selectedStates = Array.from(document.querySelectorAll("#statesCheckboxContainer input[type='checkbox']:checked"));
            const districtListContainer = document.getElementById("districtList");
            const districtContainer = districtListContainer.querySelector("#districtsCheckboxContainer") || document.createElement("div");
            districtContainer.id = "districtsCheckboxContainer";
            districtContainer.innerHTML = "";
            for (const checkbox of selectedStates) {
                const stateId = checkbox.value;
                const stateName = checkbox.dataset.name;
                try {
                    const response = await fetch(`https://cdn-api.co-vin.in/api/v2/admin/location/districts/${stateId}`);
                    const { districts } = await response.json();
                    const header = document.createElement("div");
                    header.innerHTML = `<strong>${stateName}</strong>`;
                    districtContainer.appendChild(header);
                    districts.forEach(district => {
                        const label = document.createElement("label");
                        label.innerHTML = `<input type="checkbox" value="${district.district_id}"> ${district.district_name}`;
                        districtContainer.appendChild(label);
                    });
                } catch (error) {
                    console.error(`Error fetching districts for state ID ${stateId}:`, error);
                }
            }
            if (!districtListContainer.contains(districtContainer)) {
                districtListContainer.appendChild(districtContainer);
            }
        }
        const allData = {
            week: {
                labels: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                datasets: (() => {
                    const rawData = [
                        [2, 1, 2, 1, 2, 2, 1],       // <130V
                        [3, 2, 3, 2, 2, 3, 2],       // 130V-150V
                        [4, 3, 2, 3, 2, 3, 4],       // <150V
                        [4, 5, 4, 4, 5, 4, 3],       // 150V-180V
                        [5, 6, 6, 6, 6, 6, 6],       // 180V-210V
                        [4, 5, 5, 5, 5, 4, 5],       // 210V-250V
                        [2, 2, 2, 3, 2, 2, 3]        // >250V
                    ];

                    const colors = [
                        '#E0FFFF',  // <130V - Light Gray
                        '#FAFAD2',  // 130V-150V - Light Gold
                        '#F0E68C',  // <150V - Khaki
                        '#FFDAB9',  // 150V-180V - Peach
                        '#B0E0E6',  // 180V-210V - Powder Blue
                        '#98FB98',  // 210V-250V - Pale Green
                        '#FFB6C1'   // >250V - Light Red
                    ];

                    const labels = [
                        '<130V', '130V-150V', '<150V', '150V-180V',
                        '180V-210V', '210V-250V', '>250V'
                    ];

                    return rawData.map((band, i) => ({
                        label: labels[i],
                        backgroundColor: colors[i],
                        data: band.map(val => parseFloat(((val / 24) * 100).toFixed(2))),
                        originalHours: band
                    }));
                })()

            },

            month: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: (() => {
                    const rawData = [
                        [2, 2, 2, 1, 2, 2, 2, 1, 1, 1, 2, 2],   // <130V
                        [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],   // 130V-150V
                        [3, 3, 2, 3, 2, 3, 3, 3, 3, 2, 2, 3],   // <150V
                        [4, 4, 5, 4, 4, 4, 4, 5, 4, 4, 5, 4],   // 150V-180V
                        [5, 5, 5, 6, 6, 5, 5, 5, 6, 6, 5, 6],   // 180V-210V
                        [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5],   // 210V-250V
                        [2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2]    // >250V
                    ];

                    const colors = [
                        '#E0FFFF', '#FAFAD2', '#F0E68C',
                        '#FFDAB9', '#B0E0E6', '#98FB98', '#FFB6C1'
                    ];

                    const labels = [
                        '<130V', '130V-150V', '<150V', '150V-180V',
                        '180V-210V', '210V-250V', '>250V'
                    ];

                    return rawData.map((band, i) => ({
                        label: labels[i],
                        backgroundColor: colors[i],
                        data: band.map(val => parseFloat(((val / 24) * 100).toFixed(2))),
                        originalHours: band
                    }));
                })()
            },

            yearly: {
                labels: ['2023', '2024', '2025'],
                datasets: (() => {
                    const rawData = [
                        [2, 2, 2],   // <130V
                        [2, 2, 2],   // 130V-150V
                        [3, 3, 3],   // <150V
                        [4, 4, 4],   // 150V-180V
                        [5, 5, 5],   // 180V-210V
                        [6, 6, 6],   // 210V-250V
                        [2, 2, 2]    // >250V
                    ];

                    const colors = [
                        '#E0FFFF', '#FAFAD2', '#F0E68C',
                        '#FFDAB9', '#B0E0E6', '#98FB98', '#FFB6C1'
                    ];

                    const labels = [
                        '<130V', '130V-150V', '<150V', '150V-180V',
                        '180V-210V', '210V-250V', '>250V'
                    ];

                    return rawData.map((band, i) => ({
                        label: labels[i],
                        backgroundColor: colors[i],
                        data: band.map(val => parseFloat(((val / 24) * 100).toFixed(2))),
                        originalHours: band
                    }));
                })()
            }
        };



        let currentPeriod = 'week';
        const maxWeek = 23;
        let currentWeek = maxWeek;

        const today = new Date();
        const currentSystemYear = today.getFullYear(); // 2025
        const currentSystemMonth = today.getMonth();   // 0-indexed (0 = Jan = allowed)

        let currentMonthYear = currentSystemYear;

        const chart = new Chart(document.getElementById('periodChart'), {
            type: 'bar',
            data: {
                labels: [], // Add your labels here
                datasets: [] // Add your datasets here
            },
            options: {
                scales: {
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: 100, // Percentage max
                        ticks: {
                            stepSize: 20,
                            callback: function (value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Percentage'
                        }
                    },
                    x: {
                        stacked: true
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: context => {
                                const percentage = context.parsed.y;
                                const hours = context.dataset.originalHours?.[context.dataIndex] ?? 0;
                                return `${context.dataset.label}: ${percentage}% (${hours} hrs)`;
                            }
                        }
                    }
                    ,
                    legend: {
                        position: 'bottom'
                    }
                }
            },
            plugins: [{
                id: 'labelInsideBars',
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    chart.data.datasets.forEach((dataset, datasetIndex) => {
                        const meta = chart.getDatasetMeta(datasetIndex);
                        meta.data.forEach((bar, index) => {
                            const value = dataset.data[index];
                            const bg = Array.isArray(dataset.backgroundColor) ? dataset.backgroundColor[index] : dataset.backgroundColor;
                            if (value > 0 && bg !== '#d3d3d3') {
                                ctx.fillStyle = '#000';
                                ctx.font = '12px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(value + '%', bar.x, bar.y + bar.height / 2);
                            }
                        });
                    });
                }
            }]
        });


        function getTodayIndex() {
            return new Date().getDay();
        }

        function updateDisplay() {

        }

        function updateChartData() {
            const voltageFilter = document.getElementById('voltageBandSelect').value;
            const periodDisplay = document.getElementById('periodDisplay');

            if (currentPeriod === 'week') {
                periodDisplay.innerText = `Current Week: 9-13 June,2025 (Week ${currentWeek})`;
                updateWeekChartData();
            } else if (currentPeriod === 'month') {
                periodDisplay.innerText = `Current Year: ${currentMonthYear}`;
                const baseData = allData.month;
                chart.data.labels = baseData.labels;

                let maxVisibleMonthIndex = 11;
                if (currentMonthYear === currentSystemYear) {
                    maxVisibleMonthIndex = currentSystemMonth;
                }

                const filteredDatasets = baseData.datasets
                    .filter(ds => voltageFilter === 'all' || ds.label === voltageFilter)
                    .map(ds => {
                        const newData = ds.data.map((val, idx) => {
                            return idx <= maxVisibleMonthIndex ? val : 0;
                        });
                        const newBackgroundColors = ds.data.map((_, idx) => {
                            return idx <= maxVisibleMonthIndex ? ds.backgroundColor : '#d3d3d3';
                        });
                        return { ...ds, data: newData, backgroundColor: newBackgroundColors };
                    });

                chart.data.datasets = filteredDatasets;
                chart.update();
            } else if (currentPeriod === 'yearly') {
                periodDisplay.innerText = `Yearly View`;
                const baseData = allData.yearly;
                chart.data.labels = baseData.labels;

                const filteredDatasets = baseData.datasets
                    .filter(ds => voltageFilter === 'all' || ds.label === voltageFilter)
                    .map(ds => ({ ...ds }));

                chart.data.datasets = filteredDatasets;
                chart.update();
            }
        }


        function updateWeekChartData() {
            const baseData = allData.week;
            const todayIndex = getTodayIndex();
            const voltageFilter = document.getElementById('voltageBandSelect').value;

            chart.data.labels = baseData.labels;

            const filteredDatasets = baseData.datasets
                .filter(ds => voltageFilter === 'all' || ds.label === voltageFilter)
                .map(ds => {
                    const newData = ds.data.map((val, idx) => {
                        return currentWeek === maxWeek ? (idx <= todayIndex ? val : 0) : val;
                    });

                    const newBackgroundColors = ds.data.map((_, idx) => {
                        return currentWeek === maxWeek ? (idx <= todayIndex ? ds.backgroundColor : '#d3d3d3') : ds.backgroundColor;
                    });

                    return { ...ds, data: newData, backgroundColor: newBackgroundColors };
                });

            chart.data.datasets = filteredDatasets;
            chart.update();
        }

        function changeWeek(delta) {
            const newWeek = currentWeek + delta;
            if (newWeek >= 0 && newWeek <= maxWeek) {
                currentWeek = newWeek;
                updateDisplay();
                updateChartData();
            }
        }

        function changeMonth(delta) {
            if (currentPeriod !== 'month') return;

            currentMonthYear += delta;
            updateChartData();
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentPeriod = tab.dataset.period;
                updateChartData();
            });
        });

        document.getElementById('voltageBandSelect').addEventListener('change', updateChartData);

        updateDisplay();
        updateChartData();
    </script>

</body>

</html>